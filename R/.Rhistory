# keep the overall A/E of the holdout year (across all sex / smokers)
# in a vector to estimate the out-of-sample error later
holdout_years_ae <- c()
# this will hold the results of the join
all_vbt_rankings <- NULL
# run the cross-validation like procedure
for (holdout_yr in holdout_years) {
# compute the log-likelihood for each cell after
# holding out a single calendar year
vbt_rankings <- likelihood_calc %>%
filter(Calendar_Year != !!holdout_yr) %>%
group_by(
vbt_table_version,
vbt_alb_anb,
vbt_smoker,
vbt_gender,
tbl_name,
Smoker_Status,
Gender,
Preferred_Class
) %>%
summarise(
ll = sum(ll),
.groups="drop"
) %>%
group_by(
Smoker_Status,
Gender,
Preferred_Class
) %>%
mutate(
rank = row_number(desc(ll))
) %>%
arrange(rank)
# find the best table (maximum likelihood)
best_table <- vbt_rankings %>%
filter(rank == 1)
# compute the actual-to-expected on the holdout set
holdout_ae <- likelihood_calc %>%
filter(Calendar_Year == holdout_yr) %>%
inner_join(best_table %>%
select(-c(ll:rank)), by=c(
"vbt_table_version",
"vbt_alb_anb",
"vbt_smoker",
"vbt_gender",
"tbl_name",
"Smoker_Status",
"Gender",
"Preferred_Class"
)) %>%
group_by(1) %>%
summarise(
total_claims = sum(total_claims),
exp_claims = sum(exp_claims),
ae = total_claims / exp_claims,
.groups="drop"
) %>%
pull(ae)
# keep the A/E in the holdout year for the final plot
holdout_years_ae <- c(
holdout_years_ae,
holdout_ae
)
# append the record of the best tables
if (is.null(all_vbt_rankings)) {
all_vbt_rankings <- best_table
} else {
all_vbt_rankings <- rbind(
all_vbt_rankings,
best_table
)
}
}
rm(best_table)
plot_data <- tibble(
`Holdout Year` = holdout_years,
`A/E` = holdout_years_ae
)
ggplot(plot_data, aes(x=`Holdout Year`, y=`A/E`)) +
geom_line() +
scale_y_continuous(
trans=scales::pseudo_log_trans(),
labels = scales::percent_format()) +
theme_minimal() +
ylab("Actual-to-Expected") +
ggtitle(sprintf("Holdout Year A/E (%.1f%% average)", 100*mean(holdout_years_ae)),
"Expected = Maximum Likelihood VBT Table") +
geom_hline(yintercept = 1, color="red")
plot_data <- all_vbt_rankings %>%
mutate(
tbl_name = paste0(vbt_table_version, " ", vbt_alb_anb, " ", tbl_name),
cell_name = interaction(Smoker_Status, Gender, Preferred_Class)
)
suppressWarnings({
ggplot(plot_data, aes(x=tbl_name)) +
geom_histogram(stat="count") +
facet_wrap(~ cell_name, scales="free", ncol=2) +
theme(
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
) +
coord_flip() +
theme_minimal() +
xlab("VBT Table") +
ylab("Number of Maximum Likelihood Votes") +
ggtitle("Results of maximum likelihood cross-validation")
})
best_vbt_table <- all_vbt_rankings %>%
group_by(vbt_table_version, vbt_smoker, vbt_gender, vbt_alb_anb,
tbl_name, Smoker_Status, Gender, Preferred_Class) %>%
summarise(
tbl_count = n()
) %>%
group_by(
Smoker_Status, Gender, Preferred_Class
) %>%
arrange(desc(tbl_count)) %>%
mutate(
most_common = row_number()
) %>%
filter(most_common == 1) %>%
select(-tbl_count, -most_common)
best_vbt_table %>%
mutate(
`Best Table` = paste0(
vbt_table_version, " ", vbt_alb_anb,
" ", tbl_name
)
) %>%
select(Gender, Smoker_Status, Preferred_Class, `Best Table`) %>%
arrange(Gender, Smoker_Status, Preferred_Class) %>%
kable(caption="Final Table Selection") %>%
kable_styling()
prepare_modeling_data <- function(df, table_mapping) {
df %>%
# connect the experience with the join table
inner_join(
best_vbt_table,
by=c("Smoker_Status", "Gender", "Preferred_Class")
) %>%
inner_join(
vbt_tables,
by=c("vbt_table_version"="table_version",
"vbt_smoker"="smoker",
"vbt_gender"="sex",
"vbt_alb_anb"="alb_anb",
"tbl_name"="tbl_name",
"Issue_Age"="issue_age",
"Attained_Age"="attained_age")) %>%
mutate(
Face_Amount_Band = stringr::str_trim(Face_Amount_Band),
Face_Amount = case_when(
Face_Amount_Band == "1-9999" ~ 5000,
Face_Amount_Band == "10000-24999" ~ 17500,
Face_Amount_Band == "25000-49999" ~ 37500,
Face_Amount_Band == "50000-99999" ~ 75000,
Face_Amount_Band == "100000-249999" ~ 175000,
Face_Amount_Band == "250000-499999" ~ 375000,
Face_Amount_Band == "500000-999999" ~ 750000,
Face_Amount_Band == "1000000-2499999" ~ 1750000,
Face_Amount_Band == "2500000-4999999" ~ 3750000,
Face_Amount_Band == "5000000-9999999" ~ 7500000,
Face_Amount_Band == "10000000+" ~ 15000000),
Face_Amount_Band = factor(Face_Amount_Band,
levels = c(
"1-9999",
"10000-24999",
"25000-49999",
"50000-99999",
"100000-249999",
"250000-499999",
"500000-999999",
"1000000-2499999",
"2500000-4999999",
"5000000-9999999",
"10000000+"
), ordered = T),
Face_Amount_Band_2 = forcats::fct_collapse(
Face_Amount_Band,
`2500000+` = c("2500000-4999999", "5000000-9999999", "10000000+")
),
Face_Amount_Band_Int = as.integer(Face_Amount_Band),
Expected_Deaths = Policies_Exposed * qx)
}
model_data.train <- perm_experience.train %>%
prepare_modeling_data(best_vbt_table)
model_data.test <- perm_experience.test %>%
prepare_modeling_data(best_vbt_table)
tibble(
Dataset = c("model_data.train", "model_data.test", "perm_experience"),
`Number of Deaths` = c(
sum(model_data.train$Number_Of_Deaths),
sum(model_data.test$Number_Of_Deaths),
sum(perm_experience$Number_Of_Deaths)
),
`Expected Number of Deaths (Best VBT Table)` = c(
round(sum(model_data.train$Expected_Deaths), 0),
round(sum(model_data.test$Expected_Deaths), 0),
NA
),
`Number of Exposures` = c(
round(sum(model_data.train$Policies_Exposed), 0),
round(sum(model_data.test$Policies_Exposed), 0),
round(sum(perm_experience$Policies_Exposed), 0)
)
) %>%
kable(caption="check modeling data frame") %>%
kable_styling()
plot_data <- model_data.train %>%
mutate(
cohort_name = interaction(
Gender,
Smoker_Status,
Preferred_Class,
vbt_alb_anb)
) %>%
group_by(
tbl_name,
cohort_name,
Attained_Age,
vbt_alb_anb
) %>%
summarise(
total_claims = sum(Number_Of_Deaths),
exp_claims = sum(Policies_Exposed * qx),
.groups = "drop"
) %>%
ungroup()
ggplot(plot_data, aes(x=Attained_Age, y=exp_claims, color=tbl_name, group=tbl_name)) +
geom_line() +
facet_wrap(~ cohort_name, scales="free_y") +
geom_line(
aes(y=total_claims), color="black"
) +
ggtitle("VBT Table (Expected) vs. Actual Claims", "Black line is actuals") +
ylab("Claim Count") +
xlab("Attained Age") +
theme_minimal() +
theme(
legend.position="bottom"
) +
guides(color=guide_legend(title="VBT Table:"))
options(scipen = 999)
rpart_model <- rpart(
as.matrix(model_data.train[,c("Expected_Deaths","Number_Of_Deaths")]) ~
Issue_Age + Issue_Year + Attained_Age + Gender + Preferred_Class +
Smoker_Status + Face_Amount,
data=model_data.train,
method="poisson",
control=rpart.control(cp=0.0001, maxdepth=3))
rpart_model %>%
rpart.plot(digits=3)
plot_data <- model_data.train %>%
mutate(
Face_Group = ifelse(
Face_Amount < 56200,
"<56.2K",
">56.2K")) %>%
group_by(Attained_Age, Face_Group) %>%
summarise(
Number_Of_Deaths = sum(Number_Of_Deaths),
Expected_Deaths = sum(Expected_Deaths),
`Log A/E` = log(Number_Of_Deaths / Expected_Deaths)
) %>%
filter(Expected_Deaths > 0, Number_Of_Deaths > 0)
ggplot(plot_data, aes(x=Attained_Age, y=`Log A/E`, group=Face_Group, color=Face_Group)) +
geom_point(aes( size=Number_Of_Deaths)) +
geom_smooth(method="lm", aes(weight=Number_Of_Deaths)) +
theme_minimal() +
ggtitle("Attained Age and Face Amount Interaction?",
"Non-parallel lines provide evidence of interacton")
model_wo_interaction <- glm(
Number_Of_Deaths ~ offset(log(Expected_Deaths)) +
Attained_Age + Face_Amount,
data=model_data.train,
family = poisson()
)
model_w_interaction <- glm(
Number_Of_Deaths ~ offset(log(Expected_Deaths)) +
Attained_Age * Face_Amount,
data=model_data.train,
family = poisson()
)
tibble(
`Model Variant` = c("Without Interaction", "With Interaction"),
`AIC` = c(AIC(model_wo_interaction), AIC(model_w_interaction)),
`Better Model (AIC)?` = c(
ifelse(
AIC(model_wo_interaction) < AIC(model_w_interaction),
"Y", "N"),
ifelse(
AIC(model_wo_interaction) > AIC(model_w_interaction),
"Y", "N"))) %>%
kable(caption="Model-based (AIC/BIC) approach to interaction decision") %>%
kable_styling()
plot_data <- model_data.train %>%
group_by(Attained_Age, Face_Amount_Band_2) %>%
summarise(
Number_Of_Deaths = sum(Number_Of_Deaths),
Expected_Deaths = sum(Expected_Deaths),
`Log A/E` = log(Number_Of_Deaths / Expected_Deaths)
) %>%
filter(Expected_Deaths > 0,
Number_Of_Deaths > 0)
ggplot(plot_data, aes(x=Attained_Age, y=`Log A/E`,
group=Face_Amount_Band_2,
color=Face_Amount_Band_2)) +
facet_wrap(~ Face_Amount_Band_2) +
geom_smooth(method="gam", aes(weight=Number_Of_Deaths), se=F) +
theme_minimal() +
ggtitle("Attained Age and Face Amount Interaction?",
"Non-parallel lines provide evidence of interacton")
glm_fit <- glm(
Number_Of_Deaths ~
offset(log(Expected_Deaths)) +
splines::ns(Attained_Age, knots=c(80)) *
Face_Amount_Band_2 - 1,
data=model_data.train,
family = poisson()
)
summary(glm_fit)
model_data.train["Predicted_Deaths"] <- predict(
glm_fit,
newdata = model_data.train,
type = "response"
)
rpart_model <- rpart(
as.matrix(model_data.train[,c("Predicted_Deaths","Number_Of_Deaths")]) ~
Issue_Age + Issue_Year + Attained_Age + Gender + Preferred_Class +
Smoker_Status + Face_Amount,
data=model_data.train,
method="poisson",
control=rpart.control(cp=0.0001, maxdepth=3))
rpart_model %>%
rpart.plot(digits=3)
plot_data <- model_data.train %>%
group_by(Issue_Year) %>%
summarise(
Number_Of_Deaths = sum(Number_Of_Deaths),
Predicted_Deaths = sum(Predicted_Deaths),
`Actual-to-Predicted` = log(Number_Of_Deaths / Predicted_Deaths),
.groups = "drop"
) %>%
rowwise() %>%
mutate(
poi_dev = dpois(Number_Of_Deaths, Predicted_Deaths)
)
ggplot(plot_data, aes(x=Issue_Year, y=`Actual-to-Predicted`)) +
geom_point() +
geom_smooth(method="lm") +
ylab("Log Actual to Modeled") +
theme_minimal() +
ggtitle("Issue Year vs. Model")
visreg(glm_fit, xvar=)
glm_fit_2 <- glm(Number_Of_Deaths ~
offset(log(Expected_Deaths)) +
splines::ns(Attained_Age, knots=c(80)):Face_Amount_Band_Int
+ Issue_Year
+ Calendar_Year - 1,
data=model_data.train,
family = poisson()
)
summary(glm_fit_2)
model_data.train["Predicted_Deaths"] <- predict(
glm_fit_2,
newdata = model_data.train,
type = "response"
)
rpart_model <- rpart(
as.matrix(model_data.train[,c("Predicted_Deaths","Number_Of_Deaths")]) ~
Issue_Age + Issue_Year + Attained_Age + Gender + Preferred_Class +
Smoker_Status + Face_Amount + Calendar_Year,
data=model_data.train,
method="poisson",
control=rpart.control(cp=0.0001, maxdepth=3))
rpart_model %>%
rpart.plot(digits=3)
model_data.test$Predicted_Deaths <- predict(
glm_fit_2,
newdata=model_data.test
)
sum(model_data.test$Number_Of_Deaths) / sum(model_data.test$Predicted_Deaths)
model_data.test$Predicted_Deaths <- predict(
glm_fit_2,
newdata=model_data.test,
type="response"
)
sum(model_data.test$Number_Of_Deaths) / sum(model_data.test$Predicted_Deaths)
model_formula <- Number_Of_Deaths ~
splines::ns(Attained_Age, knots=c(80)):Face_Amount_Band_Int +
Issue_Year +
Calendar_Year - 1
final_model_data.train <- model_data.train %>%
filter(Calendar_Year >= 2011)
glm_fit_final.stan <- stan_glm(
model_formula,
family = neg_binomial_2(),
offset=log(final_model_data.train$Expected_Deaths),
data=final_model_data.train,
iter=2000,
chains=4,
algorithm="optimizing",
QR=T
)
model_formula <- Number_Of_Deaths ~
splines::ns(Attained_Age, knots=c(80)):Face_Amount_Band_Int +
Issue_Year +
Calendar_Year - 1
final_model_data.train <- model_data.train
glm_fit_final.stan <- stan_glm(
model_formula,
family = neg_binomial_2(),
offset=log(final_model_data.train$Expected_Deaths),
data=final_model_data.train,
iter=2000,
algorithm="optimizing",
QR=T
)
predicted_deaths <- rstanarm::posterior_predict(
glm_fit_final.stan,
offset=log(model_data.test$Expected_Deaths),
newdata=model_data.test)
(sum(model_data.test$Number_Of_Deaths) / predicted_deaths %>% rowSums()) %>%
quantile(probs=seq(0, 1, by=0.05))
predicted_deaths <- rstanarm::posterior_predict(
glm_fit_final.stan,
offset=log(model_data.test$Expected_Deaths),
newdata=model_data.test)
plot_data <- data.frame(
ae_pp_draw = (sum(model_data.test$Number_Of_Deaths) / predicted_deaths %>% rowSums())
)
ggplot(plot_data, aes(x=ae_pp_draw)) +
geom_smooth() +
geom_vline(xintercept=1)
ggplot(plot_data, aes(x=ae_pp_draw)) +
geom_density() +
geom_vline(xintercept=1)
model_formula <- Number_Of_Deaths ~
splines::ns(Attained_Age, knots=c(80)):Face_Amount_Band_Int +
Issue_Year +
Calendar_Year - 1
final_model_data.train <- model_data.train
glm_fit_final.stan <- stan_glm(
model_formula,
family = poisson(),
offset=log(final_model_data.train$Expected_Deaths),
data=final_model_data.train,
iter=2000,
algorithm="optimizing",
QR=T
)
summary(glm_fit_final.stan)
glm_fit_final.stan <- stan_glm(
model_formula,
family = neg_binomial_2(),
offset=log(final_model_data.train$Expected_Deaths),
data=final_model_data.train,
iter=2000,
algorithm="optimizing",
QR=T
)
summary(glm_fit_final.stan)
model_formula <- Number_Of_Deaths ~
splines::ns(Attained_Age, knots=c(80)):Face_Amount_Band_Int +
Issue_Year +
Calendar_Year - 1
final_model_data.train <- model_data.train
glm_fit_final.stan <- stan_glm(
model_formula,
family = poisson(),
offset=log(final_model_data.train$Expected_Deaths),
data=final_model_data.train,
iter=2000,
chains=4,
algorithm="sampling",
QR=T
)
summary(glm_fit_final.stan)
predicted_deaths <- rstanarm::posterior_predict(
glm_fit_final.stan,
offset=log(model_data.test$Expected_Deaths),
newdata=model_data.test)
plot_data <- data.frame(
ae_pp_draw = (sum(model_data.test$Number_Of_Deaths) / predicted_deaths %>% rowSums())
)
ggplot(plot_data, aes(x=ae_pp_draw)) +
geom_density() +
geom_vline(xintercept=1)
quantile(plot_data$ae_pp_draw, probs = seq(0,1,by=0.1))
knitr::opts_chunk$set(cache = TRUE)
options(mc.cores = 4)
load_pkgs <- function(pkgs) {
for (p in pkgs) {
if (!require(p, character.only = TRUE)) {
install.packages(p, quiet = T)
require(p, character.only = TRUE)
}
}
}
load_pkgs(c("rpart", "rpart.plot", "knitr", "kableExtra",
"tidyverse", "rstanarm", "visreg", "bayesplot"))
# load data
perm_experience <- readRDS("./data/ulsg_experience.rds") %>%
filter(Policies_Exposed > 0 )
# partition into train / test
perm_experience.train <- perm_experience %>% filter(training_set == 1)
# load data
perm_experience <- readRDS("./data/ulsg_experience.rds") %>%
filter(Policies_Exposed > 0 ) %>%
mutate(
training_set = ifelse(Calendar_Year <= 2016, 1, 0)
)
